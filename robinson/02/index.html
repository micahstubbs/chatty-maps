<!DOCTYPE html>
<meta charset="utf-8" /> 
<style>
body {
  max-width: 960px;
}
canvas {
  cursor: crosshair
}
select {
  display: table;
  margin: 0 auto;
}
</style>
<body>
<script src="d3.min.js"></script>
<script src="topojson.min.js"></script>
<script src="rbush.min.js"></script>
<script src="d3.geo.projection.min.js"></script>
<script src="console.js"></script>
<script src="spam.min.js"></script>
<script src='https://code.responsivevoice.org/responsivevoice.js'></script>
<script src='ar.js'></script>
<script src='de.js'></script>
<script src='es.js'></script>
<script src='et.js'></script>
<script src='fi.js'></script>
<script src='fr.js'></script>
<script src='nl.js'></script>
<script src='pt.js'></script>
<script src='sv.js'></script>
<script src='countriesAlpha2.js'></script>

<script type='text/javascript'>
var hover = null

var width = 960
var height = 500
var graticule = d3.geo.graticule()

// Get the list of the voices
var voicelist = responsiveVoice.getVoices()

// Create the selector
d3.select("body").append("select")
  .selectAll("option")
  .data(voicelist)
  .enter()
  .append("option")
  .text(function (d) {
    return d.name
  })
  .attr("value", function (d) {
    return d.name
  })

// store the current voice
var defaultVoice = "Arabic Male" // "Spanish Female";
var currentVoice = defaultVoice;
var index = 3; // "Arabic Male" // 29 "Spanish Female"

// set the default voice
d3.select('select').property("selectedIndex", index);
responsiveVoice.setDefaultVoice(currentVoice)

// Fire the lang function according to the selector
d3.select("select").on("change", lang);

function lang() {
  var selectedValue = d3.event.target.value;
  currentVoice = selectedValue;
  // Set the voice
  return responsiveVoice.setDefaultVoice(selectedValue);
}

// create an object that allows us to use an English country name
// to lookup the ISO-3166-1 alpha-2 country code
var alpha2Lookup = {};
countriesAlpha2.forEach(function (d) {
  alpha2Lookup[d.Name] = d.Code;
})

// draw the map
d3.json("world.json", function(error, d) {
  topojson.presimplify(d)
  
  var map = new StaticCanvasMap({
    element: "body",
    width: width,
    projection: d3.geo.robinson(),
    data: [{
      features: topojson.feature(d, d.objects["countries"]),
      static: {
        prepaint: function(parameters) {
          parameters.context.beginPath()
          parameters.path(graticule())
          parameters.context.lineWidth = 0.5
          parameters.context.strokeStyle = 'rgb(200,200,200)'
          parameters.context.stroke()

          parameters.context.beginPath()
          parameters.path({type: "Sphere"})
          parameters.context.lineWidth = 1
          parameters.context.strokeStyle = 'rgb(30,30,30)'
          parameters.context.stroke()
        },
        paintfeature: function(parameters, d) {
          parameters.context.lineWidth = 0.5
          parameters.context.strokeStyle = 'rgb(30,30,30)'
          parameters.context.stroke()

          parameters.context.fillStyle = "rgb(188, 223, 255)";
          parameters.context.fill()
        }
      },
      dynamic: {
        postpaint: function(parameters) {
          if (!hover)
            return

          parameters.context.beginPath()
          parameters.context.lineWidth = 1 / parameters.scale
          parameters.path(hover)
          parameters.context.stroke()
        }
      },
      events: {
        click: function(parameters, d) {
          console.log('d from click event', d);

          // speak silently to find out the language of the currentVoice
          responsiveVoice.speak("", currentVoice, {volume: 0})
          var language = logOfConsole[logOfConsole.length - 1].arguments[0]['lang'];
          var language2 = language.substring(0,2);
          console.log('language', language, 'language2', language2);
          var countryName = d.id;
          var countryCode;

          switch(language2) {
            case 'ar':
              countryCode = alpha2Lookup[d.id];
              countryName = ARi18n[countryCode];
              break;
            case 'de':
              countryCode = alpha2Lookup[d.id];
              countryName = DEi18n[countryCode];            
              break;
            case 'es':
              countryCode = alpha2Lookup[d.id];
              countryName = ESi18n[countryCode];
              break;
            case 'et':
              countryCode = alpha2Lookup[d.id];
              countryName = ETi18n[countryCode];
              break;
            case 'fi':
              countryCode = alpha2Lookup[d.id];
              countryName = FIi18n[countryCode];              
              break;
            case 'fr':
              countryCode = alpha2Lookup[d.id];
              countryName = FRi18n[countryCode];              
              break;
            case 'nl':
              countryCode = alpha2Lookup[d.id];
              countryName = NLi18n[countryCode];              
              break;
            case 'pt':
              countryCode = alpha2Lookup[d.id];
              countryName = PTi18n[countryCode];              
              break;
            case 'sv':
              countryCode = alpha2Lookup[d.id];
              countryName = SVi18n[countryCode];              
              break;        
            default:
              break;
          }
          
          console.log('countryName', countryName, 'countryCode', countryCode);

          // When clicking on a feature, say the name of that country
          d && responsiveVoice.speak(countryName)
        },
        hover: function(parameters, d) {
          hover = d

          parameters.map.paint()
        }
      }
    }]
  })
  map.init()
})
</script>
